<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Inktober 2025 â€“ Jour 10</title>
  <style>
    :root { --safe-bottom: env(safe-area-inset-bottom, 0px); }

    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0; height: 100%;
      overflow: hidden; background: #d9c9a3; font-family: system-ui, sans-serif;
    }

    .canvas-container {
      position: fixed; inset: 0; width: 100dvw; height: 100dvh;
      background: #f5e9c8;
    }
    #canvas {
      display: block; width: 100%; height: 100%; background: #f5e9c8; cursor: crosshair;
      touch-action: none;
    }

    .toolbar {
      position: fixed; left: 0; right: 0; bottom: 0;
      padding: 10px 16px calc(10px + var(--safe-bottom));
      background: rgba(62,47,28,0.95); color: #f5e9c8;
      display: flex; gap: 16px; justify-content: center; align-items: center; flex-wrap: wrap;
      border-top: 2px solid #3e2f1c; backdrop-filter: blur(6px); z-index: 10;
      touch-action: auto;
    }
    button {
      background: #3e2f1c; color: #f5e9c8; border: none; border-radius: 8px;
      padding: 10px 18px; font-size: 15px; cursor: pointer; transition: .2s;
    }
    button:hover { background: #604b33; }
    label { display: flex; align-items: center; gap: 6px; font-size: 14px; }
    input[type="range"] { width: 110px; accent-color: #f5e9c8; }
    input[type="color"] { width: 40px; height: 30px; border: none; border-radius: 4px; padding: 0; background: transparent; }

    @media (max-width: 768px) {
      .toolbar { gap: 10px; padding: 8px 10px calc(8px + var(--safe-bottom)); }
      input[type="range"] { width: 90px; }
    }
    @media (max-width: 480px) {
      .toolbar { flex-direction: column; }
      button { width: 100%; }
    }

    /* Bouton d'activation du son (secours) */
    #soundBtn { display: none; }
    .show-sound-btn #soundBtn { display: inline-block; }
  </style>
</head>
<body>

  <canvas id="canvas"></canvas>

  <!-- Lecteur audio cachÃ© (fichier Ã  cÃ´tÃ© du HTML) -->
  <audio id="bgm" src="./song.mp3" preload="auto"></audio>

  <div class="toolbar" id="toolbar">
    <button id="clearBtn">Effacer la toile</button>
    <label>Ã‰paisseur :
      <input type="range" id="widthRange" min="5" max="80" value="35">
    </label>
    <label>Encre :
      <input type="color" id="colorPicker" value="#111111">
    </label>
    <button id="soundBtn">ðŸ”Š Activer le son</button>
  </div>

  <!-- Fabric.js + Fabric Brushes -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/av01d/fabric-brushes/dist/fabric.brushes.min.js"></script>

  <script>
    // === Canvas plein Ã©cran ===
    const canvasEl = document.getElementById('canvas');
    const canvas = new fabric.Canvas('canvas', { isDrawingMode: true, enableRetinaScaling: true });

    function resizeCanvas() {
      const w = Math.floor(window.innerWidth);
      const h = Math.floor(window.innerHeight);
      canvas.setDimensions({ width: w, height: h });
      const container = canvas.getElement().parentNode;
      container.style.width  = w + 'px';
      container.style.height = h + 'px';
      canvas.setBackgroundColor('#f5e9c8', canvas.renderAll.bind(canvas));
      canvas.calcOffset();
    }
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('orientationchange', () => setTimeout(resizeCanvas, 100));
    resizeCanvas();

    // === Pinceau InkBrush ===
    let brushColor = '#111111';
    let brushWidth = 35;
    const inkBrush = new fabric.InkBrush(canvas);
    inkBrush.color = brushColor;
    inkBrush.width = brushWidth;
    inkBrush.opacity = 0.85;
    canvas.freeDrawingBrush = inkBrush;

    // Corrige le micro-dÃ©calage
    canvas.on('path:created', ({ path }) => {
      if (path) path.set({ left: Math.round(path.left), top: Math.round(path.top) });
      canvas.requestRenderAll();
    });

    // === ContrÃ´les ===
    document.getElementById('clearBtn').onclick = () => {
      canvas.clear();
      canvas.setBackgroundColor('#f5e9c8', canvas.renderAll.bind(canvas));
    };
    document.getElementById('widthRange').oninput = (e) => {
      brushWidth = +e.target.value;
      inkBrush.width = brushWidth;
    };
    document.getElementById('colorPicker').oninput = (e) => {
      brushColor = e.target.value;
      inkBrush.color = brushColor;
    };

    // === Audio ===
    const audio = document.getElementById('bgm');
    audio.loop = true;
    audio.volume = 0; // dÃ©part Ã  volume 0

    const soundBtn = document.getElementById('soundBtn');
    const toolbar = document.getElementById('toolbar');

    async function fadeInAudio() {
      audio.volume = 0;
      const fadeDuration = 2000; // 2 secondes
      const steps = 20; // nombre de paliers
      const stepTime = fadeDuration / steps;
      for (let i = 0; i <= steps; i++) {
        const vol = i / steps;
        setTimeout(() => { audio.volume = vol; }, i * stepTime);
      }
    }

    async function startSound() {
      try {
        await audio.play();
        fadeInAudio();
        document.removeEventListener('pointerdown', startSoundOnce, true);
        document.removeEventListener('keydown', startSoundOnce, true);
        toolbar.classList.remove('show-sound-btn');
      } catch (err) {
        console.warn('Lecture audio bloquÃ©e :', err);
        toolbar.classList.add('show-sound-btn');
      }
    }

    function startSoundOnce() {
      startSound();
    }

    // DÃ©marre le son Ã  la premiÃ¨re interaction utilisateur
    document.addEventListener('pointerdown', startSoundOnce, true);
    document.addEventListener('keydown', startSoundOnce, true);

    // Bouton de secours si autoplay bloquÃ©
    soundBtn.addEventListener('click', startSound);
  </script>
</body>
</html>
