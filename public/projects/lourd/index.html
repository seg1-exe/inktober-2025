<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lourd â€” Inktober 2025</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
      height: 100%;
      font-family: "Inter", sans-serif;
      color: white;
      touch-action: none;
    }

    #intro {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      height: 100vh;
      background-image: url('backgroundpc.png');
      transition: opacity 1s;
      text-align: center;
      padding: 0 1em;
    }

    .win98 {
    margin: auto;
    font-family: MS Sans Serif;
    width: 350px;
    padding: 3px;
    background: #c3c3c3;
    color: #000;
    border-top: 2px solid #c1c1be;
    border-right: 2px solid #818181;
    border-bottom: 2px solid #818181;
    border-left: 2px solid #deddd9;
    }

    .title {
    font-size: 16px;
    padding: 2px;
    color: #fff;
    background: linear-gradient(
        90deg,
        rgba(17, 43, 111, 1) 0%,
        rgba(94, 123, 177, 1) 35%,
        rgba(161, 200, 241, 1) 100%
    );
    }

    .msg {
    padding: 5px;
    font-size: 14px;
    }

    button {
    padding: 2px 0;
    width: 80px;
    background: #c3c3c3;
    border-top: 2px solid #fdffff;
    border-right: 2px solid #818181;
    border-bottom: 2px solid #818181;
    border-left: 2px solid #fdffff;
    }

    button:hover {
    background: #c3c3c3;
    border-top: 2px solid #818181;
    border-right: 2px solid #fdffff;
    border-bottom: 2px solid #fdffff;
    border-left: 2px solid #818181;
    }

    button:active {
    background: #c3c3c3;
    border: 2px solid #818181;
    }

    .close {
    float: right;
    margin-top: -1px;
    width: 20px;
    padding: 1px;
    }

    .btn-group {
    margin: auto;
    width: 50%;
    }

    #container {
      position: fixed;
      inset: 0;
      overflow: hidden;
      display: none;
      touch-action: none;
    }

    .media {
      position: absolute;
      object-fit: cover;
      opacity: 0;
      animation: appear 0.4s ease forwards;
      filter: brightness(1.2);
      pointer-events: none;
      transition: transform 0.2s ease;
    }

    video.media {
        pointer-events: none;
    }


    @keyframes appear {
      to { opacity: 1; transform: scale(1.05); }
    }

    /* ---- Responsive media sizes ---- */
    @media (min-width: 1024px) {
      .media { max-width: 25vw; max-height: 25vh; }
    }

    @media (max-width: 1023px) and (min-width: 768px) {
      .media { max-width: 35vw; max-height: 35vh; }
    }

    @media (max-width: 767px) {
      .media { max-width: 45vw; max-height: 45vh; }
    }

    @media (max-width: 480px) {
        #intro { background-image: url('backgroundphone.png'); background-size: cover; }
      .media { max-width: 55vw; max-height: 55vh; }
    }
  </style>
</head>
<body>
  <div id="intro">
    <div class="win98">
    <p class="title">Message Box <button class="close">X</button></p>
    <p class="msg">Voulez-vous rentrer dans l'expÃ©rience ?!</p>
    <div class="btn-group">
      <button id="cancel-btn">Non</button>
      <button id="enter-btn">OUI</button>
    </div>
  </div>
  </div>

  <div id="container"></div>

  <audio id="music" loop src="sonday9.mp3"></audio>
  <audio id="boo-sound" src="boo.mp3"></audio>

  <script type="module">
import mediaFiles from './mediaList.js';

const bpm = 149;
const beatInterval = 60 / bpm;
const container = document.getElementById("container");
const music = document.getElementById("music");
const intro = document.getElementById("intro");
const enterBtn = document.getElementById("enter-btn");
const cancelBtn = document.getElementById("cancel-btn");
const booSound = document.getElementById("boo-sound");

cancelBtn.addEventListener("click", () => {
  booSound.currentTime = 0;
  booSound.play();
});

let spawnCount = window.innerWidth < 768 ? 1 : 3;
const MAX_ELEMENTS = window.innerWidth < 768 ? 40 : 140;
const MAX_VIDEOS = window.innerWidth < 768 ? 3 : 8;

// ðŸ§© SÃ©parer les images et vidÃ©os
const imageFiles = mediaFiles.filter(f => /\.(jpg|jpeg|png|gif|webp)$/i.test(f));
const videoFiles = mediaFiles.filter(f => /\.(mp4|webm|mov)$/i.test(f));

let videoCache = [];
let videosReady = false;

// PrÃ©chargement des vidÃ©os
function preloadVideos() {
  return Promise.all(
    videoFiles.map(src => {
      return new Promise(resolve => {
        const v = document.createElement("video");
        v.src = `./medias/${src}`;
        v.preload = "auto";
        v.muted = true;
        v.playsInline = true;
        v.setAttribute("playsinline", "");
        v.setAttribute("webkit-playsinline", "");
        v.oncanplaythrough = () => {
          videoCache.push(v);
          resolve(v);
        };
        v.onerror = resolve; // ne bloque pas si une vidÃ©o Ã©choue
      });
    })
  ).then(() => {
    console.log(`ðŸŽ¥ ${videoCache.length}/${videoFiles.length} vidÃ©os prÃªtes`);
    videosReady = true;
  });
}

enterBtn.addEventListener("click", async () => {
  if (!booSound.paused) {
    booSound.pause();
    booSound.currentTime = 0;
  }

  intro.style.opacity = 0;
  setTimeout(() => {
    intro.style.display = "none";
    container.style.display = "block";
  }, 1000);

  // ðŸŒ€ Lancer la musique et le flux dâ€™images immÃ©diatement
  music.play();
  startImagePhase();

  // ðŸš€ En parallÃ¨le, on charge les vidÃ©os
  await preloadVideos();

  // ðŸŽ¬ DÃ¨s que la moitiÃ© des vidÃ©os sont prÃªtes, on ajoute les vidÃ©os au flux
  videosReady = true;
  console.log("âœ… Les vidÃ©os sont prÃªtes Ã  apparaÃ®tre !");
});

function startImagePhase() {
  let phase = "images";

  setInterval(() => {
    for (let i = 0; i < spawnCount; i++) {
      // Si les vidÃ©os sont prÃªtes, on mÃ©lange images + vidÃ©os
      if (videosReady) {
        spawnRandomMedia();
      } else {
        spawnImageOnly();
      }
    }
  }, beatInterval * 1000);
}

// ----------------------------------

let recentMedia = [];

function spawnImageOnly() {
  if (imageFiles.length === 0) return;
  let fileName;
  do {
    fileName = imageFiles[Math.floor(Math.random() * imageFiles.length)];
  } while (recentMedia.includes(fileName) && imageFiles.length > 5);

  recentMedia.push(fileName);
  if (recentMedia.length > 5) recentMedia.shift();

  const el = document.createElement("img");
  el.src = `./medias/${fileName}`;
  el.className = "media";
  el.onload = () => placeElement(el);
  container.appendChild(el);

  setTimeout(() => el.remove(), 8000);
  if (container.children.length > MAX_ELEMENTS)
    container.removeChild(container.firstChild);
}

function spawnRandomMedia() {
  let isVideo = Math.random() < 0.4 && videoCache.length > 0; // 40% de vidÃ©os quand prÃªtes
  const pool = isVideo ? videoFiles : imageFiles;
  let fileName;
  do {
    fileName = pool[Math.floor(Math.random() * pool.length)];
  } while (recentMedia.includes(fileName) && pool.length > 5);

  recentMedia.push(fileName);
  if (recentMedia.length > 5) recentMedia.shift();

  const el = document.createElement(isVideo ? "video" : "img");
  el.className = "media";
  const file = `./medias/${fileName}`;

  if (isVideo) {
    const cachedVideo = videoCache.find(v => v.src.endsWith(fileName));
    if (!cachedVideo) return;
    el.src = cachedVideo.src;
    el.loop = true;
    el.muted = true;
    el.autoplay = true;
    el.playsInline = true;
    el.setAttribute("playsinline", "");
    el.setAttribute("webkit-playsinline", "");
    el.preload = "metadata";
  } else {
    el.src = file;
  }

  const handleReady = () => placeElement(el);
  if (isVideo) el.onloadeddata = handleReady;
  else el.onload = handleReady;

  container.appendChild(el);
  setTimeout(() => el.remove(), 8000);
  if (container.children.length > MAX_ELEMENTS)
    container.removeChild(container.firstChild);
}

function placeElement(el) {
  const screenW = window.innerWidth;
  const screenH = window.innerHeight;
  const elW = el.offsetWidth || screenW * 0.25;
  const elH = el.offsetHeight || screenH * 0.25;
  const maxLeft = screenW - elW;
  const maxTop = screenH - elH;
  el.style.left = `${Math.random() * maxLeft}px`;
  el.style.top = `${Math.random() * maxTop}px`;
}

window.addEventListener("resize", () => {
  spawnCount = window.innerWidth < 768 ? 1 : 3;
});
</script>


</body>
</html>
