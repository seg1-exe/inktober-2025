<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lourd ‚Äî Inktober 2025</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
      height: 100%;
      font-family: "Inter", sans-serif;
      color: white;
      touch-action: none;
    }

    #intro {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      height: 100vh;
      background-image: url('backgroundpc.png');
      transition: opacity 1s;
      text-align: center;
      padding: 0 1em;
    }

    .win98 {
    margin: auto;
    font-family: MS Sans Serif;
    width: 350px;
    padding: 3px;
    background: #c3c3c3;
    color: #000;
    border-top: 2px solid #c1c1be;
    border-right: 2px solid #818181;
    border-bottom: 2px solid #818181;
    border-left: 2px solid #deddd9;
    }

    .title {
    font-size: 16px;
    padding: 2px;
    color: #fff;
    background: linear-gradient(
        90deg,
        rgba(17, 43, 111, 1) 0%,
        rgba(94, 123, 177, 1) 35%,
        rgba(161, 200, 241, 1) 100%
    );
    }

    .msg {
    padding: 5px;
    font-size: 14px;
    }

    button {
    padding: 2px 0;
    width: 80px;
    background: #c3c3c3;
    border-top: 2px solid #fdffff;
    border-right: 2px solid #818181;
    border-bottom: 2px solid #818181;
    border-left: 2px solid #fdffff;
    }

    button:hover {
    background: #c3c3c3;
    border-top: 2px solid #818181;
    border-right: 2px solid #fdffff;
    border-bottom: 2px solid #fdffff;
    border-left: 2px solid #818181;
    }

    button:active {
    background: #c3c3c3;
    border: 2px solid #818181;
    }

    .close {
    float: right;
    margin-top: -1px;
    width: 20px;
    padding: 1px;
    }

    .btn-group {
    margin: auto;
    width: 50%;
    }

    #container {
      position: fixed;
      inset: 0;
      overflow: hidden;
      display: none;
      touch-action: none;
    }

    .media {
      position: absolute;
      object-fit: cover;
      opacity: 0;
      animation: appear 0.4s ease forwards;
      filter: brightness(1.2);
      pointer-events: none;
      transition: transform 0.2s ease;
    }

    video.media {
        pointer-events: none;
    }


    @keyframes appear {
      to { opacity: 1; transform: scale(1.05); }
    }

    /* ---- Responsive media sizes ---- */
    @media (min-width: 1024px) {
      .media { max-width: 25vw; max-height: 25vh; }
    }

    @media (max-width: 1023px) and (min-width: 768px) {
      .media { max-width: 35vw; max-height: 35vh; }
    }

    @media (max-width: 767px) {
      .media { max-width: 45vw; max-height: 45vh; }
    }

    @media (max-width: 480px) {
        #intro { background-image: url('backgroundphone.png'); background-size: cover; }
      .media { max-width: 55vw; max-height: 55vh; }
    }
  </style>
</head>
<body>
  <div id="intro">
    <div class="win98">
    <p class="title">Message Box <button class="close">X</button></p>
    <p class="msg">Voulez-vous rentrer dans l'exp√©rience ?!</p>
    <div class="btn-group">
      <button id="cancel-btn">Non</button>
      <button id="enter-btn">OUI</button>
    </div>
  </div>
  </div>

  <div id="container"></div>

  <audio id="music" loop src="sonday9.mp3"></audio>
  <audio id="boo-sound" src="boo.mp3"></audio>

  <script type="module">
import mediaFiles from './mediaList.js';

const bpm = 149;
const beatInterval = 60 / bpm;
const container = document.getElementById("container");
const music = document.getElementById("music");
const intro = document.getElementById("intro");
const enterBtn = document.getElementById("enter-btn");
const cancelBtn = document.getElementById("cancel-btn");
const booSound = document.getElementById("boo-sound");

cancelBtn.addEventListener("click", () => {
  booSound.currentTime = 0;
  booSound.play();
});

let spawnCount = window.innerWidth < 768 ? 1 : 3;
const MAX_ELEMENTS = window.innerWidth < 768 ? 40 : 140;
let MAX_VIDEOS = window.innerWidth < 768 ? 1 : 6;

const imageFiles = mediaFiles.filter(f => /\.(jpg|jpeg|png|gif|webp)$/i.test(f));
const videoFiles = mediaFiles.filter(f => /\.(mp4|webm|mov)$/i.test(f));

let videoCache = [];
let videosReady = false;
let videoBuffer = []; // vid√©os pr√™tes mais pas encore affich√©es

enterBtn.addEventListener("click", () => {
  if (!booSound.paused) {
    booSound.pause();
    booSound.currentTime = 0;
  }

  intro.style.opacity = 0;
  setTimeout(() => {
    intro.style.display = "none";
    container.style.display = "block";
  }, 500); // plus r√©actif

  // üåÄ D√©marre la musique et le flux d‚Äôimages imm√©diatement
  music.play();
  startSpawnLoop();

  // üöÄ Pr√©charge les vid√©os silencieusement
  preloadVideos();
});

function preloadVideos() {
  const total = videoFiles.length;
  let readyCount = 0;

  videoFiles.forEach(src => {
    const v = document.createElement("video");
    v.src = `./medias/${src}`;
    v.preload = "auto";
    v.muted = true;
    v.playsInline = true;
    v.setAttribute("playsinline", "");
    v.setAttribute("webkit-playsinline", "");

    v.oncanplaythrough = () => {
      if (!videoCache.includes(v)) {
        videoCache.push(v);
        readyCount++;
        // garde 2 vid√©os d‚Äôavance avant d‚Äôactiver le flux
        if (readyCount >= 2 && !videosReady) {
          videosReady = true;
          console.log("üé¨ Premi√®res vid√©os pr√™tes !");
        }
      }
    };

    // Fallback si certaines vid√©os √©chouent
    v.onerror = () => readyCount++;
  });

  // S√©curit√© : force l‚Äôactivation apr√®s 8 s m√™me si peu charg√©es
  setTimeout(() => {
    if (!videosReady && videoCache.length > 0) {
      videosReady = true;
      console.log("‚è±Ô∏è Activation forc√©e des vid√©os apr√®s 8 s");
    }
  }, 8000);
}

function startSpawnLoop() {
  // üí° Premier visuel instantan√© pour √©viter tout vide
  for (let i = 0; i < spawnCount; i++) spawnImage();

  setInterval(() => {
    for (let i = 0; i < spawnCount; i++) {
      if (videosReady && Math.random() < 0.3) {
        spawnVideo();
      } else {
        spawnImage();
      }
    }
  }, beatInterval * 1000);
}

let recentMedia = [];

function spawnImage() {
  if (!imageFiles.length) return;

  let fileName;
  do {
    fileName = imageFiles[Math.floor(Math.random() * imageFiles.length)];
  } while (recentMedia.includes(fileName) && imageFiles.length > 5);

  recentMedia.push(fileName);
  if (recentMedia.length > 5) recentMedia.shift();

  const el = document.createElement("img");
  el.src = `./medias/${fileName}`;
  el.className = "media";
  el.onload = () => placeElement(el);
  container.appendChild(el);

  setTimeout(() => el.remove(), 8000);
  if (container.children.length > MAX_ELEMENTS)
    container.removeChild(container.firstChild);
}

function spawnVideo() {
  if (!videosReady || !videoCache.length) return;
  if (document.querySelectorAll("video.media").length >= MAX_VIDEOS) return;

  // R√©cup√®re une vid√©o d√©j√† pr√™te
  const v = videoCache[Math.floor(Math.random() * videoCache.length)];
  const el = v.cloneNode(true);

  el.className = "media";
  el.autoplay = true;
  el.loop = true;
  el.muted = true;
  el.playsInline = true;
  el.setAttribute("playsinline", "");
  el.setAttribute("webkit-playsinline", "");

  el.onloadeddata = () => placeElement(el);
  container.appendChild(el);

  setTimeout(() => el.remove(), 8000);
  if (container.children.length > MAX_ELEMENTS)
    container.removeChild(container.firstChild);
}

function placeElement(el) {
  const w = window.innerWidth, h = window.innerHeight;
  const elW = el.offsetWidth || w * 0.25;
  const elH = el.offsetHeight || h * 0.25;
  el.style.left = `${Math.random() * (w - elW)}px`;
  el.style.top = `${Math.random() * (h - elH)}px`;
}

window.addEventListener("resize", () => {
  spawnCount = window.innerWidth < 768 ? 1 : 3;
  MAX_VIDEOS = window.innerWidth < 768 ? 1 : 6;
});



</script>


</body>
</html>
